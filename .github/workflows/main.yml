name: Scrape Events

on:
  workflow_dispatch:
  schedule:
    - cron: '0 14 * * FRI'  # Every Friday at 10:00 AM Toronto time

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ§¾ Checkout repo
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install playwright beautifulsoup4 requests python-dotenv playwright-stealth

    - name: ğŸ”§ Install Playwright Browsers
      run: |
        python -m playwright install chromium

    - name: âœ… Install Async Stealth Fork
      run: |
        pip uninstall -y playwright_stealth
        pip install git+https://github.com/AtuboDad/playwright_stealth.git

    - name: ğŸ§ª Run Python Scraper (with xvfb for headful mode)
      env:
        GMAIL_USER: ${{ secrets.GMAIL_USER }}
        GMAIL_PASS: ${{ secrets.GMAIL_PASS }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
        LANG: en_US.UTF-8
        TZ: America/Toronto
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb
        xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24' python events_emailer.py

    - name: ğŸ“¤ Upload output HTML
      uses: actions/upload-artifact@v4
      with:
        name: eventbrite-html
        path: weekend_events_toronto.html
